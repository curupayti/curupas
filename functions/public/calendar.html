<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CRUD Firebase</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="css/vendor/font-awesome.min.css">
    <link rel="stylesheet" href="css/vendor/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/style_calendar.css">
    <link rel="icon" type="image/x-icon" href="https://vigil.com.ar/favicons/curupa.ico" />    
  </head>

  <body>
           
    <header></header>

        <div id='wrap'>
            <div id='calendar'></div>
            <div style='clear:both'></div>
        </div>
    
    <footer></footer>

    <script src="js/html_loader.js"></script>

    <script src="js/vendor/jquery.min.js"></script>
    <script src="js/vendor/bootstrap.min.js"></script>    

    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>

    <script src="https://cdn.ckeditor.com/4.5.10/standard/ckeditor.js"></script>

    
    <script>	

        var firebaseConfig = {
            apiKey: "AIzaSyCNW0DWuH4U-4Fa8IQLNiZc5Fxlvov0G_Y",
            authDomain: "curupas-backen.firebaseapp.com",
            databaseURL: "https://curupas-backen.firebaseio.com",
            projectId: "curupas-backen",
            storageBucket: "curupas-backen.appspot.com",
            messagingSenderId: "464846058000",
            appId: "1:464846058000:web:f1c764fb76fcc6455e5095",
            measurementId: "G-PBMTQWBJ6X"
        }; 
        firebase.initializeApp(firebaseConfig);  

        /*firebase.auth().onAuthStateChanged(function (user) {
            if (!user) {
                window.location.href = 'login.html';
            } 
        });*/

        const db = firebase.firestore();
        const storage = firebase.storage();         

        $(document).ready(function () {         
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
            ];

            const d = new Date();            
                
            var  year = new Date().getFullYear();
            var month = monthNames[d.getMonth()];

            var calendarEvents = [];  

            db.collection('calendar').onSnapshot(snapshot => {
                let size = snapshot.size;
                var count = 0;
                let changes = snapshot.docChanges();
                changes.forEach(change => {
                    let doc = change.doc;

                    let name = doc.data().name;
                    let className = doc.data().className;
                    let allDay = doc.data().allDay;
                    let start = doc.data().start;
                    let date = Date(doc.data().timeStamp); 

                    let event = {
                        title: name,
                        start: date,
                        allDay: allDay,
                        className: className
                    };

                    calendarEvents.push(event);

                    if (count == (size-1)) {                    
                        initializeCalendar(calendarEvents);
                    }
                    count++;
                });
            });

            
          /*db.collection("calendar").doc(year + "/" + monthNames[d.getMonth()])
            .onSnapshot(function(doc) {          
              exist = true;
              console.log("Document data:", doc.data());
              $("#title").val(doc.data().title);
              $("#content").text(doc.data().description);          
          });

          $("#updateButton").on("click", function(e) {
            e.preventDefault();   
          });

          $("#submitTittle").on("click", function(e) {      
            e.preventDefault();        
            var now = firebase.firestore.FieldValue.serverTimestamp();
            var title = {
              title: $('#title').val(), 
              description: $("#content").val(),            
              updatedAt: now
              //updatedBy : user.name
            };
            db.collection("titles").doc("home").set(title).then(()=>{        
              $('#editTitleModal').modal('hide');
            });

            return false;
          });*/

        });


        function initializeCalendar(events) {

                var date = new Date();
              var d = date.getDate();
              var m = date.getMonth();
              var y = date.getFullYear();
              /*  className colors
                
              className: default(transparent), important(red), chill(pink), success(green), info(blue)
                
              */
              /* initialize the external events
              -----------------------------------------------------------------*/
              $('#external-events div.external-event').each(function() {
                // create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
                // it doesn't need to have a start or end
                var eventObject = {
                  title: $.trim($(this).text()) // use the element's text as the event title
                };
                // store the Event Object in the DOM element so we can get to it later
                $(this).data('eventObject', eventObject);
                // make the event draggable using jQuery UI
                $(this).draggable({
                  zIndex: 999,
                  revert: true, // will cause the event to go back to its
                  revertDuration: 0 //  original position after the drag
                });
              });
              /* initialize the calendar
              -----------------------------------------------------------------*/
              var calendar = $('#calendar').fullCalendar({
                header: {
                  left: 'title',
                  center: 'agendaDay,agendaWeek,month',
                  right: 'prev,next today'
                },
                editable: true,
                firstDay: 0, //  1(Monday) this can be changed to 0(Sunday) for the USA system
                selectable: true,
                defaultView: 'month',
                axisFormat: 'h:mm',
                columnFormat: {
                  month: 'ddd', // Mon
                  week: 'ddd d', // Mon 7
                  day: 'dddd M/d', // Monday 9/7
                  agendaDay: 'dddd d'
                },
                titleFormat: {
                  month: 'MMMM yyyy', // September 2009
                  week: "MMMM yyyy", // September 2009
                  day: 'MMMM yyyy' // Tuesday, Sep 8, 2009
                },
                allDaySlot: false,
                selectHelper: true,
                select: function(start, end, allDay) {
                  var title = prompt('Event Title:');
                  if (title) {
                    calendar.fullCalendar('renderEvent', {
                        title: title,
                        start: start,
                        end: end,
                        allDay: allDay
                      },
                      true // make the event "stick"
                    );
                  }
                  calendar.fullCalendar('unselect');
                },
                droppable: true, // this allows things to be dropped onto the calendar !!!
                drop: function(date, allDay) { // this function is called when something is dropped
                  // retrieve the dropped element's stored Event Object
                  var originalEventObject = $(this).data('eventObject');
                  // we need to copy it, so that multiple events don't have a reference to the same object
                  var copiedEventObject = $.extend({}, originalEventObject);
                  // assign it the date that was reported
                  copiedEventObject.start = date;
                  copiedEventObject.allDay = allDay;
                  // render the event on the calendar
                  // the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
                  $('#calendar').fullCalendar('renderEvent', copiedEventObject, true);
                  // is the "remove after drop" checkbox checked?
                  if ($('#drop-remove').is(':checked')) {
                    // if so, remove the element from the "Draggable Events" list
                    $(this).remove();
                  }
                },
                events: [ events /*{
                    title: 'All Day Event',
                    start: new Date(y, m, 1)
                  },
                  {
                    id: 999,
                    title: 'Repeating Event',
                    start: new Date(y, m, d - 3, 16, 0),
                    allDay: false,
                    className: 'info'
                  },
                  {
                    id: 999,
                    title: 'Repeating Event',
                    start: new Date(y, m, d + 4, 16, 0),
                    allDay: false,
                    className: 'info'
                  },
                  {
                    title: 'Meeting',
                    start: new Date(y, m, d, 10, 30),
                    allDay: false,
                    className: 'important'
                  },
                  {
                    title: 'Lunch',
                    start: new Date(y, m, d, 12, 0),
                    end: new Date(y, m, d, 14, 0),
                    allDay: false,
                    className: 'important'
                  },
                  {
                    title: 'Birthday Party',
                    start: new Date(y, m, d + 1, 19, 0),
                    end: new Date(y, m, d + 1, 22, 30),
                    allDay: false,
                  },
                  {
                    title: 'Click for Google',
                    start: new Date(y, m, 28),
                    end: new Date(y, m, 29),
                    url: 'https://ccp.cloudaccess.net/aff.php?aff=5188',
                    className: 'success'
                  }*/
                ],
              });
        }

    </script>  

    <script src="js/script_calendar.js"></script>

  </body>

</html>
