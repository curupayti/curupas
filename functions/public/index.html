<!DOCTYPE html>

    <html lang="es">

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Curupas</title>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="css/vendor/font-awesome.min.css">
        <link rel="stylesheet" href="css/vendor/bootstrap.min.css">             
        <link rel="icon" type="image/x-icon" href="https://vigil.com.ar/favicons/curupa.ico"/>                
        <link type="text/css" rel="stylesheet" href="html/loading_indicator/jquery.loading-indicator.css" />
    </head>

    <body>

        <header></header>  

        <div id="content"></div>

        <footer></footer>        

        <script src="js/vendor/jquery.min.js"></script>
        <script src="js/vendor/bootstrap.min.js"></script>    
        <script src="html/loading_indicator/jquery.loading-indicator.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js"></script>        
        <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>
        <script src="https://cdn.ckeditor.com/4.5.10/standard/ckeditor.js"></script>

    </body>

    <script>    
        

        var homeLoader = $('body').loadingIndicator({ useImage: false,}).data("loadingIndicator");

        const firebaseConfig = {
            apiKey: "AIzaSyBJffXixRGSguaXNQxbtZb_am90NI9nGHg",
            authDomain: "curupas-app.firebaseapp.com",
            databaseURL: "https://curupas-app.firebaseio.com",
            projectId: "curupas-app",
            storageBucket: "curupas-app.appspot.com",
            messagingSenderId: "813267916846",
            appId: "1:813267916846:web:529f9c18a84b6b45aa67bf",
            measurementId: "G-2RRZXWLMTL"
        };
        firebase.initializeApp(firebaseConfig);

        var db = firebase.firestore();

        var getUrlParameter = function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
        };

        var role = getUrlParameter('role');

        if (role==undefined) {   

            firebase.auth().onAuthStateChanged(function (user) {

                if (user) {

                    console.log(user.email);

                    var previous = db.collection("users").where("email", "==", user.email)
                    .get()
                    .then(function(querySnapshot) {
                        querySnapshot.forEach(function(doc) {                        
                            var types =  doc.data().type;
                            window.location.href = 'index.html?role=' + types;
                        });
                    })
                    .catch(function(error) {
                        console.log("Error getting documents: ", error);
                    });

                } else {

                    homeLoader.hide();

                    $("<link/>", {
                        rel: "stylesheet",
                        type: "text/css",
                        href: "/css/login.css"
                    }).appendTo("head");

                    fetch("../html/content/login.html")
                    .then(response => {
                        return response.text();
                    })
                    .then(data => {
                    
                        $("#content").html(data);    
                    
                        $('#btn-login').click(function(e) {                            
                            e.preventDefault(); 

                            var inputEmail = $("#inputEmail").val();
                            var inputPassword = $("#inputPassword").val();                        

                            firebase.auth().signInWithEmailAndPassword(inputEmail, inputPassword).catch(function(error) {  
                                var errorCode = error.code;
                                var errorMessage = error.message;  
                            });

                        });
                    });
                }

            });
                
        } else {            
                      
            $("<link/>", {
                rel: "stylesheet",
                type: "text/css",
                href: "/css/style.css"
            }).appendTo("head");            

            var roleArray = [];
            
            if (role.indexOf(',') == -1) {
                
                roleArray.push(parseInt(role));

            } else {

                roleArray = role.split(',');                
            }

            // Build Header
            var navBarArray = [];

            for (var i=0; i<roleArray.length; i++) {

                var r = roleArray[i];

                switch (r) {
                    //Guest
                    case 0:                        
                        break;
                    //Admin
                    case 1:
                        navBarArray.push({html:"title.html", css:"title.css", desc: "Titulo"});
                        navBarArray.push({html:"post.html", css:"post.css", desc: "Posts"});                 
                        break;
                    //Referent
                    case 2:
                        
                        break;
                    //Group
                    case 3:
                        
                        break;
                    //Museum
                    case 4:
                        
                        break;                                    
                    //Calendar
                    case 5:
                        
                        break;                                    
                }

            } 
            
            fetch("../html/header.html")
            .then(response => {
                return response.text()
            })
            .then(data => {
                
                $("header").html(data);   
                
                for (var j=0;j<navBarArray.length; j++) {
                    
                    var html = navBarArray[j].html;
                    var css = navBarArray[j].css;
                    var desc = navBarArray[j].desc;

                    $("#navbar").append('<li class="nav-item"><a class="nav-link" href="javascript:void(0);" onclick="loadPage(\'' + html + '\', \'' + css + '\'); return false;">' + desc + '</a></li>');           
                }

                homeLoader.hide();
            });
            
            fetch("../html/footer.html")
            .then(response => {
                return response.text()
            })
            .then(data => {
                document.querySelector("footer").innerHTML = data;
            });

            function loadPage(html, css) {

                homeLoader.show();

                $("<link/>", {
                    rel: "stylesheet",
                    type: "text/css",
                    href: "/css/" + css
                }).appendTo("head");

                fetch("../html/content/" + html)
                .then(response => {
                    return response.text();
                })
                .then(data => {                
                    $("#content").html(data);     
                    homeLoader.hide();                                  
                });

            }
                                         
        }    
        

      /*  } else {
            
            homeLoader.hide();

            //$.getScript("js/loader.js");

            fetch("../html/header.html")
            .then(response => {
                return response.text()
            })
            .then(data => {
                //document.querySelector("header").innerHTML = data;  
                $("header").html(data);   
                $("#navbar").append('<li class="nav-item"><a class="nav-link" href="nuseum.html">Museum</a></li>')   
            });

            $("<link/>", {
                rel: "stylesheet",
                type: "text/css",
                href: "/css/style.css"
            }).appendTo("head");

            $("<link/>", {
                rel: "stylesheet",
                type: "text/css",
                href: "/css/post.css"
            }).appendTo("head");
                
            fetch("../html/content/post.html")
            .then(response => {
                return response.text();
            })
            .then(data => {
                $("#content").html(data);                        
            });  

        }   */
    
    </script>

    </html>