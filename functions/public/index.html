<!DOCTYPE html>

    <html lang="es">

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Curupas</title>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="css/vendor/font-awesome.min.css">
        <link rel="stylesheet" href="css/vendor/bootstrap.min.css">             
        <link rel="icon" type="image/x-icon" href="https://vigil.com.ar/favicons/curupa.ico"/>                
        <link type="text/css" rel="stylesheet" href="html/loading_indicator/jquery.loading-indicator.css" />
    </head>

    <body>

        <header></header>  

        <div id="content"></div>

        <footer></footer>        

        <script src="js/vendor/jquery.min.js"></script>
        <script src="js/vendor/bootstrap.min.js"></script> 
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@beta/dist/js.cookie.min.js"></script>   
        <script src="html/loading_indicator/jquery.loading-indicator.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-app.js"></script>
        <script src="https://www.gstatic.com/firebasejs/7.2.1/firebase-firestore.js"></script>
        <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase-storage.js"></script>        
        <script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-auth.js"></script>        

    </body>

    <script>    
        
        var roleWebArray = [];

        var homeLoader = $('body').loadingIndicator({ useImage: false,}).data("loadingIndicator");

        const firebaseConfig = {
            apiKey: "AIzaSyBJffXixRGSguaXNQxbtZb_am90NI9nGHg",
            authDomain: "curupas-app.firebaseapp.com",
            databaseURL: "https://curupas-app.firebaseio.com",
            projectId: "curupas-app",
            storageBucket: "curupas-app.appspot.com",
            messagingSenderId: "813267916846",
            appId: "1:813267916846:web:529f9c18a84b6b45aa67bf",
            measurementId: "G-2RRZXWLMTL"
        };
        firebase.initializeApp(firebaseConfig);

        var db = firebase.firestore();

        var getUrlParameter = function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
        };

        var role = getUrlParameter('role');

        if (role==undefined) {   

            firebase.auth().onAuthStateChanged(function (user) {

                if (user) {

                    console.log(user.email);

                    var previous = db.collection("users").where("email", "==", user.email)
                    .get()
                    .then(function(querySnapshotUser) {
                        querySnapshotUser.forEach(function(docUser) {                        
                            var roleReference =  docUser.data().role;

                            roleReference.get()
                            .then(function(docPage) {                     

                                var json = docPage.data();                                
                                
                                var count = Object.keys(json).length;
                                var c = 0;
                                
                                Object.keys(json).forEach((name) => {
                                    var reference = json[name];

                                    var promises = [];

                                    promises.push(reference.get());
                                  
                                    Promise.all(promises).then(function(responses) {        

                                        for (var i=0; i<responses.length; i++) {
                                            let page = responses[i].data(); 
                                            var _id   =  page.id;
                                            var _name =  page.name;
                                            var _html =  page.html;
                                            var _js =  page.js;
                                            var _css  =   page.css; 
                                            roleWebArray.push({id:_id, html:_html, js:_js, css:_css, desc:_name});
                                        }

                                        if (c == (count-1)) {
                                            renderNavbar(roleWebArray);
                                        }
                                        c++;
                                        
                                    });                               
                                });
                            });                    
                        });
                    })
                    .catch(function(error) {
                        console.log("Error getting documents: ", error);
                    });

                } else {

                    homeLoader.hide();

                    $("<link/>", {
                        rel: "stylesheet",
                        type: "text/css",
                        href: "/css/login.css"
                    }).appendTo("head");

                    fetch("../html/content/login.html")
                    .then(response => {
                        return response.text();
                    })
                    .then(data => {
                    
                        $("#content").html(data);    
                        roleArray
                        $('#btn-login').click(function(e) {                            
                            e.preventDefault(); 

                            var inputEmail = $("#inputEmail").val();
                            var inputPassword = $("#inputPassword").val();                        

                            firebase.auth().signInWithEmailAndPassword(inputEmail, inputPassword).catch(function(error) {  
                                var errorCode = error.code;
                                var errorMessage = error.message;  
                            });

                        });
                    });
                }
            });
                
        } 
        
        function renderNavbar (navBar)  {
                      
            $("<link/>", {
                rel: "stylesheet",
                type: "text/css",
                href: "/css/style.css"
            }).appendTo("head");                    
            
            fetch("../html/header.html")
            .then(response => {
                return response.text()
            })
            .then(data => {
                
                $("header").html(data);   
                
                for (var j=0;j<navBar.length; j++) {
                    
                    var id = navBar[j].id;
                    var desc = navBar[j].desc;
                    var html = navBar[j].html;
                    var js = navBar[j].js;
                    var css = navBar[j].css;                   

                    $("#navbar").append('<li class="nav-item"><a id="' + id + '" class="nav-link" href="javascript:void(0);" onclick="loadPage(\'' + id + '\', \'' + html + '\', \'' + js + '\', \'' + css + '\'); return false;">' + desc + '</a></li>');           
                }
                
                loadPage(navBar[0].id, navBar[0].html, navBar[0].js, navBar[0].css);

                //Levanta la ultima pagina navegada sino Home
                /*let cookie = Cookies.get('html');
                if (cookie === undefined) {
                    loadPage(navBar[0].html, navBar[0].css);
                } else {
                    let html =  Cookies.get('html', html);
                    let cee = Cookies.set('html', css);
                    loadPage(html, css)
                }*/

                homeLoader.hide();
            });
            
            fetch("../html/footer.html")
            .then(response => {
                return response.text()
            })
            .then(data => {
                document.querySelector("footer").innerHTML = data;
            });           

        }

        function loadPage(id, html, js, css) {

            $("#"+id).addClass('active');

            Cookies.set('id', id);
            Cookies.set('html', html);
            Cookies.set('css', css);

            homeLoader.show();

            $("<link/>", {
                rel: "stylesheet",
                type: "text/css",
                href: "/css/" + css
            }).appendTo("head");            

            fetch("../html/content/" + html)
            .then(response => {
                return response.text();
            })
            .then(data => {                
                $("#content").html(data);     
                $.getScript("js/" + js);
                homeLoader.hide();                                  
            });

        }        

   
    </script>

    </html>